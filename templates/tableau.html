{% load compress %}{% load hq_shared_tags %}<!DOCTYPE html>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
<script type="text/javascript" src="{% new_static 'jquery/dist/jquery.min.js' %}"></script>
<script type="text/javascript" src="{% new_static 'style/lib/bootstrap-3.2.0/dist/js/bootstrap.min.js' %}"></script>
<script type="text/javascript" src="https://icds.commcarehq.org/javascripts/api/tableau-2.0.0.min.js "></script>

<script type="text/javascript" src="{% new_static 'underscore/underscore.js' %}"></script>


<div class="container-fluid">
    <div class="row">
        <div id="sideNav" class="col-md-3">
            <h2 class="text-center">Reports</h2>
        </div>
        <div class="col-md-7">
            {#    TODO: update this div to use B3 spacing that is the right size.#}
            <div id="tableauPlaceholder" style="width:1100px; height:900px;"></div>
        </div>
        <div class="col-md-2">
            <button id="inspectButton" class="btn btn-block btn-primary" disabled="disabled">Inspect</button>
            <div id="drilldown" class="well">
            </div>
        </div>
    </div>

</div>



<script>
    var viz = {};
    var workbook = {}
    function initializeViz() {
        var placeholderDiv = document.getElementById("tableauPlaceholder");
        var url = "https://icds.commcarehq.org/#/views/POCReports/MainDashboard";
        var options = {
            width: placeholderDiv.offsetWidth,
            height: placeholderDiv.offsetHeight,
            hideTabs: true,
            hideToolbar: true,
            onFirstInteractive: function () {
                setUpNav(viz)
            }
        };
        viz = new tableau.Viz(placeholderDiv, url, options);
    }

    function setUpNav(viz) {
        workbook = viz.getWorkbook();
        var sheets = workbook.getPublishedSheetsInfo();
        _.each(sheets, function(sheet) {
            addNavigationButton(sheet.$0.name, sheet.$0.isActive)
        })
        $(".btn").click(function (){
            var btn = $(this);
            workbook.activateSheetAsync(btn[0].textContent);
            $(".btn.btn-success").removeClass('btn-success').addClass('btn-default');
            btn.removeClass('btn-default').addClass('btn-success');

        })

        viz.addEventListener(tableau.TableauEventName.MARKS_SELECTION, onMarksSelection);
    }

    function addNavigationButton(sheetName, isActive) {
        var btnColor = isActive  ? 'success' : 'default';
        var html = "<div class='row'><button class='btn btn-block btn-" + btnColor + "'>" + sheetName + "</btn></div>";
        $("#sideNav").append(html);
    }

    function onMarksSelection(marksEvent) {
        console.log('onMarksSelection', marksEvent);
        return marksEvent.getMarksAsync().then(activateDrilldown);
    }

    function activateDrilldown(marks) {
        console.log('onMarksSelection', marks   );
        clearDrilldown();
        {# marks is an array of what the user has clicked #}
        var html = [];
        var sheetName = '';
        var filters = {};
        var params = {};
        for (var markIndex = 0; markIndex < marks.length; markIndex++) {
            var pairs = marks[markIndex].getPairs();
            for (var pairIndex = 0; pairIndex < pairs.length; pairIndex++) {
                var pair = pairs[pairIndex];
                html.push("<li><b>" + pair.fieldName + "</b>: "+ pair.formattedValue + "</li>");

                // Find the sheet we are navigating to
                if(pair.fieldName === 'js_sheet') {
                    console.log('sheetName = ', pair.formattedValue);
                    sheetName = pair.formattedValue;
                }

                // Split out params and filters to be applied
                var FILTER_SUBSTRING = 'ATTR(js_key_',
                    PARAM_SUBSTRING = 'ATTR(js_param_';
                if(pair.fieldName.includes(FILTER_SUBSTRING)) {
                    var filter_key = pair.fieldName.slice(FILTER_SUBSTRING.length, -1);
                    filters[filter_key] = pair.formattedValue;
                }
                if(pair.fieldName.includes(PARAM_SUBSTRING)) {
                    var param_key = pair.fieldName.slice(PARAM_SUBSTRING.length, -1);
                    params[param_key] = pair.formattedValue;
                }

            }
            html.push("</ul>");
        }


        html = html.join("");
        console.log('html', html);

        $("#drilldown").append(html);

        // Add inspect button listener
        $("#inspectButton").unbind('click').click(function() {
            // TODO: Handle the case where we are in the same sheet, might just need to apply filters then?
            console.log('Activating: ', sheetName);
            var worksheet;
            workbook.activateSheetAsync(sheetName)
                    .then(function(sheet) {
                        worksheet = sheet;
                        console.log('Setting sheet')
                    }).then(function(){
                        key = 'Location Key';
                        value  = filters[key];
                        console.log('Applying filter to: ', key, ', value: ', value);
                        debugger
                        return worksheet.applyFilterAsync(key, value, tableau.FilterUpdateType.ADD);
                    }).then(function() {
                        //_.each(params, function(value, key, list) {
                        key = 'View By';
                        value = params[key];

                        console.log('Applying parameter to: ', key, ' value: ', value);
                        return worksheet.changeParameterValueAsync(key, value);
                        //});

                    }).otherwise(function(err){
                        console.log(err);
                    })
            ;
        }).prop('disabled', false);

        console.log(filters)
        console.log(params)
    }

    function clearDrilldown() {
        $("#drilldown").empty();
        // TODO: Disabling the button doesn't work
        $("#inspectButton").prop('disabled', true);
    }

    initializeViz()





</script>
